<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Scanner QR - Contr√¥le Acc√®s</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 8px; height: 100vh; display: flex; flex-direction: column; }
        .header { background: white; border-radius: 12px 12px 0 0; padding: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .header h1 { color: #1f2937; font-size: 18px; margin-bottom: 2px; }
        .header p { color: #6b7280; font-size: 11px; }
        .fullscreen-btn { position: absolute; top: 8px; left: 8px; background: #667eea; color: white; border: none; border-radius: 6px; padding: 6px 10px; font-size: 16px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 100; }
        .fullscreen-btn:active { background: #5568d3; }
        .cache-status { font-size: 9px; color: #6b7280; margin-top: 2px; }
        .cache-status.loading { color: #f59e0b; }
        .cache-status.ready { color: #10b981; }
        .cache-status.error { color: #ef4444; }
        .config-box { background: #fef3c7; border-left: 3px solid #f59e0b; padding: 8px; margin: 0; color: #92400e; font-size: 11px; }
        .config-box.success { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .config-box input, .config-box select { width: 100%; padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px; margin: 4px 0; background: white; }
        .config-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .config-box button { padding: 6px; background: #667eea; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 11px; }
        .btn-cache { background: #10b981; }
        .scanner-box { background: white; padding: 8px; flex: 1; display: flex; flex-direction: column; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 6px; }
        .btn { padding: 8px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-start { background: #10b981; color: white; }
        .btn-stop { background: #ef4444; color: white; }
        #scannerStatus { padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; display: inline-block; margin-bottom: 6px; }
        #scannerStatus.active { background: #d1fae5; color: #065f46; }
        #scannerStatus.inactive { background: #fee2e2; color: #991b1b; }
        .list-indicator { display: inline-block; padding: 4px 12px; background: #f3f4f6; border-radius: 12px; font-size: 10px; font-weight: 600; margin-left: 8px; }
        .list-indicator.active { background: #d1fae5; color: #065f46; }
        #reader { border: 3px solid #667eea; border-radius: 8px; overflow: hidden; background: #000; flex: 0 0 350px; }
        .bottom-section { background: white; border-radius: 0 0 12px 12px; padding: 8px; box-shadow: 0 -2px 4px rgba(0,0,0,0.1); }
        .manual-section { margin-bottom: 8px; }
        .manual-section h3 { color: #4b5563; font-size: 11px; margin-bottom: 6px; }
        .input-group { display: flex; gap: 6px; }
        .input-group input { flex: 1; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px; }
        .input-group button { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .stat-column { background: #f9fafb; border-radius: 8px; padding: 8px; }
        .stat-column-title { font-size: 10px; font-weight: bold; color: #6b7280; margin-bottom: 6px; text-align: center; text-transform: uppercase; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #e5e7eb; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-size: 9px; color: #4b5563; }
        .stat-value { font-size: 16px; font-weight: bold; }
        .stat-value.green { color: #10b981; }
        .stat-value.yellow { color: #f59e0b; }
        .stat-value.red { color: #ef4444; }
        .stat-value.black { color: #1f2937; }
        .result { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; padding: 25px; border-radius: 16px; text-align: center; animation: zoomIn 0.3s ease; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; }
        @keyframes zoomIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .result.success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .result.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .result.error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .result-icon { font-size: 60px; margin-bottom: 10px; }
        .result-name { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
        .result-message { font-size: 20px; margin-bottom: 10px; font-weight: bold; }
        .result-atelier { font-size: 28px; font-weight: bold; padding: 15px 25px; background: rgba(255,255,255,0.25); border-radius: 12px; display: inline-block; margin-top: 12px; }
        .result-time { margin-top: 10px; font-size: 11px; opacity: 0.9; }
        @media (max-width: 480px) { .result-name { font-size: 24px; } .result-atelier { font-size: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">‚õ∂</button>
            <h1>üé´ Contr√¥le d'Acc√®s</h1>
            <p>Scanner automatique PleinEcran</p>
            <div class="cache-status" id="cacheStatus">‚è≥ Chargement...</div>
        </div>
        <div class="config-box" id="configBox">
            <strong>‚öôÔ∏è Configuration</strong>
            <input type="text" id="apiUrl" placeholder="URL API Google Apps Script">
            <div style="margin: 6px 0;">
                <label style="font-size: 11px;">üìã S√©lectionner la liste:</label>
                <select id="listSelect" onchange="changeList()"><option value="">Chargement...</option></select>
            </div>
            <div class="config-buttons">
                <button onclick="saveConfig()">üíæ Enregistrer</button>
                <button class="btn-cache" onclick="loadCache()">üì• Charger cache</button>
            </div>
        </div>
        <div class="scanner-box">
            <div class="controls">
                <button class="btn btn-start" id="cameraBtnToggle" onclick="toggleCamera()">üì∑ Actif</button>
                <button class="btn" id="flashBtn" style="background: #667eea; color: white;" onclick="toggleFlash()">üî¶ Flash OFF</button>
                <button class="btn" id="modeBtn" style="background: #f59e0b; color: white;" onclick="toggleMode()">üè≠ Atelier</button>
            </div>
            <div>
                <div id="scannerStatus" class="inactive">‚ö´ Arr√™t√©</div>
                <span class="list-indicator" id="listIndicator">üìã -</span>
            </div>
            <div id="reader"></div>
        </div>
        <div class="bottom-section">
            <div class="manual-section">
                <h3>‚úçÔ∏è Manuel</h3>
                <div class="input-group">
                    <input type="text" id="manualCode" placeholder="Code">
                    <button onclick="checkManual()">‚úì</button>
                </div>
            </div>
            <div class="stats">
                <div class="stat-column">
                    <div class="stat-column-title">Mes Scans</div>
                    <div class="stat-row"><span class="stat-label">‚úÖ Autoris√©</span><span class="stat-value green" id="statPersonnelOK">0</span></div>
                    <div class="stat-row"><span class="stat-label">‚ö†Ô∏è Mauvais</span><span class="stat-value yellow" id="statPersonnelKO">0</span></div>
                    <div class="stat-row"><span class="stat-label">‚ùå Refus√©</span><span class="stat-value red" id="statPersonnelRefuse">0</span></div>
                </div>
                <div class="stat-column">
                    <div class="stat-column-title">Total</div>
                    <div class="stat-row"><span class="stat-label">‚úÖ Autoris√©</span><span class="stat-value green" id="statGlobalOK">0</span></div>
                    <div class="stat-row"><span class="stat-label">‚ö†Ô∏è Mauvais</span><span class="stat-value yellow" id="statGlobalKO">0</span></div>
                    <div class="stat-row"><span class="stat-label">‚ùå Refus√©</span><span class="stat-value red" id="statGlobalRefuse">0</span></div>
                </div>
                <div class="stat-column">
                    <div class="stat-column-title">Restants</div>
                    <div id="statsRestants">
                        <div class="stat-row"><span class="stat-label">üé§ Conf</span><span class="stat-value black" id="statRestantConf">0</span></div>
                        <div class="stat-row"><span class="stat-label">üè≠ Atelier</span><span class="stat-value black" id="statRestantAtel">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="result"></div>
    <script>
        let scanner=null,apiUrl=localStorage.getItem('apiUrl')||'',stats=JSON.parse(localStorage.getItem('stats')||'{"ok":0,"ko":0,"refuse":0}'),scanning=false,scannerActive=false,localCache=[],usingCache=false,currentMode='atelier',flashEnabled=false,currentListName='',availableLists=[],statsRefreshInterval=null,isFullscreen=false;
        
        window.onload=()=>{
            updateStats();
            if(apiUrl){
                document.getElementById('apiUrl').value=apiUrl;
                document.getElementById('configBox').className='config-box success'
            }
            currentMode=localStorage.getItem('scanMode')||'atelier';
            currentListName=localStorage.getItem('currentList')||'';
            updateModeDisplay();
            loadAvailableLists();
            startStatsRefresh();
            requestFullscreen();
        };
        
        async function loadAvailableLists(){
            const statusEl=document.getElementById('cacheStatus');
            if(!apiUrl){
                statusEl.className='cache-status error';
                statusEl.textContent='‚ùå API non configur√©e';
                return
            }
            try{
                const response=await fetch(`${apiUrl}?action=getActiveLists&t=${Date.now()}`);
                const data=await response.json();
                if(data.success&&data.lists){
                    availableLists=data.lists;
                    updateListSelect();
                    const activeLists=availableLists.filter(l=>l.estActive);
                    if(activeLists.length>0){
                        statusEl.className='cache-status ready';
                        statusEl.textContent=`‚úÖ ${activeLists.length} liste(s) active(s)`
                    }else{
                        statusEl.className='cache-status error';
                        statusEl.textContent='‚ö†Ô∏è Aucune liste active'
                    }
                }else{
                    statusEl.className='cache-status error';
                    statusEl.textContent='‚ùå Erreur: '+(data.error||'R√©ponse invalide')
                }
            }catch(e){
                statusEl.className='cache-status error';
                statusEl.textContent='‚ùå Erreur connexion'
            }
        }
        
        function updateListSelect(){
            const select=document.getElementById('listSelect');
            select.innerHTML='';
            const activeLists=availableLists.filter(l=>l.estActive);
            if(activeLists.length===0){
                select.innerHTML='<option value="">Aucune liste active</option>';
                return
            }
            activeLists.forEach(list=>{
                const option=document.createElement('option');
                option.value=list.nom;
                option.textContent=list.nom;
                select.appendChild(option)
            });
            if(currentListName&&activeLists.find(l=>l.nom===currentListName)){
                select.value=currentListName
            }else{
                select.value=activeLists[0].nom;
                currentListName=activeLists[0].nom;
                localStorage.setItem('currentList',currentListName)
            }
            updateListIndicator();
            updateModeButtonVisibility();
            updateRestantsDisplay()
        }
        
        function changeList(){
            const select=document.getElementById('listSelect');
            currentListName=select.value.trim();
            if(!currentListName){
                alert('S√©lectionnez une liste');
                return
            }
            localStorage.setItem('currentList',currentListName);
            updateListIndicator();
            updateModeButtonVisibility();
            updateRestantsDisplay();
            loadCache();
            loadGlobalStats()
        }
        
        function updateListIndicator(){
            const indicator=document.getElementById('listIndicator');
            const selectedList=availableLists.find(l=>l.nom===currentListName);
            if(selectedList){
                const activeClass=selectedList.estActive?'active':'';
                const status=selectedList.estActive?'üü¢':'‚ö´';
                indicator.textContent=`${status} ${currentListName}`;
                indicator.className=`list-indicator ${activeClass}`
            }else{
                indicator.textContent='üìã -';
                indicator.className='list-indicator'
            }
        }
        
        function updateModeDisplay(){
            const btn=document.getElementById('modeBtn');
            if(currentMode==='atelier'){
                btn.textContent='üè≠ Atelier';
                btn.style.background='#f59e0b'
            }else{
                btn.textContent='üé§ Conf√©rence';
                btn.style.background='#10b981'
            }
        }
        
        function updateModeButtonVisibility(){
            const btn=document.getElementById('modeBtn');
            const singleLocationLists=['AG','TERROIR','GALA','MIDI - MER','MIDI - JEU'];
            btn.style.display=singleLocationLists.includes(currentListName)?'none':'block'
        }
        
        function updateRestantsDisplay(){
            const singleLocationLists=['AG','TERROIR','GALA','MIDI - MER','MIDI - JEU'];
            const container=document.getElementById('statsRestants');
            if(singleLocationLists.includes(currentListName)){
                container.innerHTML='<div class="stat-row"><span class="stat-label">üìã Total</span><span class="stat-value black" id="statRestantTotal">0</span></div>'
            }else{
                container.innerHTML='<div class="stat-row"><span class="stat-label">üé§ Conf</span><span class="stat-value black" id="statRestantConf">0</span></div><div class="stat-row"><span class="stat-label">üè≠ Atelier</span><span class="stat-value black" id="statRestantAtel">0</span></div>'
            }
        }
        
        function getSingleLocationName(listName){
            const locationMap={'AG':'Assembl√©e G√©n√©rale','TERROIR':'Terroir','GALA':'Gala','MIDI - MER':'MIDI - Mercredi','MIDI - JEU':'MIDI - Jeudi'};
            return locationMap[listName]||null
        }
        
        function toggleMode(){
            currentMode=currentMode==='atelier'?'conference':'atelier';
            localStorage.setItem('scanMode',currentMode);
            updateModeDisplay()
        }
        
        function saveConfig(){
            const url=document.getElementById('apiUrl').value.trim();
            if(!url){
                alert('Entrez une URL');
                return
            }
            if(!url.includes('script.google.com')){
                alert('URL invalide');
                return
            }
            apiUrl=url;
            localStorage.setItem('apiUrl',url);
            document.getElementById('configBox').className='config-box success';
            loadAvailableLists()
        }
        
        async function loadCache(){
            const statusEl=document.getElementById('cacheStatus');
            statusEl.className='cache-status loading';
            statusEl.textContent='‚è≥ Chargement cache...';
            if(!apiUrl||!currentListName){
                statusEl.className='cache-status error';
                statusEl.textContent='‚ùå Configuration incompl√®te';
                return
            }
            try{
                const response=await fetch(`${apiUrl}?action=getAll&listeName=${encodeURIComponent(currentListName)}&t=${Date.now()}`);
                const data=await response.json();
                if(data.success&&data.participants){
                    localCache=data.participants;
                    localStorage.setItem('localCache',JSON.stringify(localCache));
                    localStorage.setItem('currentListCache',currentListName);
                    usingCache=true;
                    statusEl.className='cache-status ready';
                    statusEl.textContent=`‚úÖ Cache charg√© (${localCache.length} personnes) - ${currentListName}`
                }else{
                    statusEl.className='cache-status error';
                    statusEl.textContent='‚ùå Impossible de charger le cache'
                }
            }catch(e){
                statusEl.className='cache-status error';
                statusEl.textContent='‚ùå Erreur connexion'
            }
        }
        
        function toggleCamera(){
            scannerActive?stopScanner():startScanner()
        }
        
        async function startScanner(){
            if(!apiUrl||!currentListName||!usingCache){
                alert('Configuration incompl√®te. Configurez l\'API et chargez le cache.');
                return
            }
            if(scannerActive)return;
            try{
                scanner=new Html5Qrcode("reader");
                await scanner.start({facingMode:"environment"},{fps:10,qrbox:{width:200,height:200}},onScanSuccess,()=>{});
                scannerActive=true;
                const btn=document.getElementById('cameraBtnToggle');
                btn.textContent='‚èπÔ∏è Arr√™ter';
                btn.className='btn btn-stop';
                document.getElementById('scannerStatus').className='active';
                document.getElementById('scannerStatus').textContent='üü¢ Actif'
            }catch(err){
                alert('Erreur cam√©ra')
            }
        }
        
        function stopScanner(){
            if(scanner&&scannerActive){
                scanner.stop().then(()=>{
                    scannerActive=false;
                    const btn=document.getElementById('cameraBtnToggle');
                    btn.textContent='üì∑ Actif';
                    btn.className='btn btn-start';
                    document.getElementById('scannerStatus').className='inactive';
                    document.getElementById('scannerStatus').textContent='‚ö´ Arr√™t√©';
                    flashEnabled=false;
                    document.getElementById('flashBtn').textContent='üî¶ Flash OFF';
                    document.getElementById('flashBtn').style.background='#667eea'
                })
            }
        }
        
        function toggleFlash(){
            if(!scannerActive){
                alert('D√©marrez le scanner d\'abord');
                return
            }
            flashEnabled=!flashEnabled;
            const btn=document.getElementById('flashBtn');
            if(scanner){
                scanner.applyVideoConstraints({advanced:[{torch:flashEnabled}]}).then(()=>{
                    btn.textContent=flashEnabled?'üî¶ Flash ON':'üî¶ Flash OFF';
                    btn.style.background=flashEnabled?'#fbbf24':'#667eea'
                }).catch(()=>{
                    alert('Flash non support√©');
                    flashEnabled=false;
                    btn.textContent='üî¶ Flash OFF';
                    btn.style.background='#667eea'
                })
            }
        }
        
        function onScanSuccess(code){
            if(scanning)return;
            scanning=true;
            scanner.pause(true);
            verifyCodeLocal(code)
        }
        
        function checkManual(){
            const code=document.getElementById('manualCode').value.trim();
            if(!code){
                alert('Entrez un code');
                return
            }
            if(scannerActive)scanner.pause(true);
            scanning=true;
            verifyCodeLocal(code);
            document.getElementById('manualCode').value=''
        }
        
        function verifyCodeLocal(code){
            const now=new Date();
            const heure=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');
            const date=String(now.getDate()).padStart(2,'0')+'/'+String(now.getMonth()+1).padStart(2,'0')+'/'+now.getFullYear();
            const participant=localCache.find(p=>p.code.toLowerCase()===code.toLowerCase());
            if(participant){
                const singleLocation=getSingleLocationName(currentListName);
                if(singleLocation){
                    stats.ok++;
                    beepAtelierA();
                    showResultCustom('success',participant.nom,'AUTORIS√â',singleLocation,heure,date);
                    syncToServer(code,participant.nom,heure,date,singleLocation,currentListName,'AUTORISE')
                }else{
                    const participantType=String(participant.atelier).trim().toUpperCase();
                    let typeAttendu=currentMode==='atelier'?['ATELIER A','ATELIER B']:['CONFERENCE'];
                    const estAutorise=typeAttendu.some(t=>participantType===t.toUpperCase());
                    const estMauvaisMode=(currentMode==='atelier'&&participantType==='CONFERENCE')||(currentMode==='conference'&&(participantType==='ATELIER A'||participantType==='ATELIER B'));
                    if(estAutorise){
                        stats.ok++;
                        beepAtelierA();
                        showResultCustom('success',participant.nom,'AUTORIS√â',participant.atelier,heure,date);
                        syncToServer(code,participant.nom,heure,date,currentMode,currentListName,'AUTORISE')
                    }else if(estMauvaisMode){
                        stats.ko++;
                        beepMauvaisMode();
                        showResultCustom('warning',participant.nom,'MAUVAIS MODE',participant.atelier,heure,date);
                        syncToServer(code,participant.nom,heure,date,currentMode,currentListName,'MAUVAIS MODE')
                    }else{
                        stats.refuse++;
                        beepNonAutorise();
                        showResultCustom('error',code,'NON AUTORIS√â','','','')
                    }
                }
            }else{
                stats.refuse++;
                beepNonAutorise();
                showResultCustom('error',code,'NON AUTORIS√â','','','')
            }
            localStorage.setItem('stats',JSON.stringify(stats));
            updateStats();
            setTimeout(resumeScanner,3000)
        }
        
        function resumeScanner(){
            scanning=false;
            if(scanner&&scannerActive)scanner.resume()
        }
        
        async function syncToServer(code,nom,heure,date,mode,listeName,statut){
            try{
                await fetch(`${apiUrl}?code=${encodeURIComponent(code)}&heure=${encodeURIComponent(heure)}&date=${encodeURIComponent(date)}&lieu=${encodeURIComponent(mode)}&listeName=${encodeURIComponent(listeName)}&statut=${encodeURIComponent(statut)}&sync=1&t=${Date.now()}`);
                setTimeout(()=>loadGlobalStats(),500)
            }catch(e){
                console.log('Sync √©chou√©e')
            }
        }
        
        function showResultCustom(type,nom,statut,atelier,heure,date){
            let icon=type==='success'?'‚úÖ':type==='warning'?'‚ö†Ô∏è':'‚ùå';
            const time=(heure&&date)?`<div class="result-time">${date} √† ${heure}</div>`:'';
            document.getElementById('result').innerHTML=`<div class="result ${type}"><div class="result-icon">${icon}</div><div class="result-name">${esc(nom)}</div><div class="result-message">${esc(statut)}</div><div class="result-atelier">${esc(atelier)}</div>${time}</div>`;
            setTimeout(()=>{
                document.getElementById('result').innerHTML=''
            },3000)
        }
        
        function updateStats(){
            document.getElementById('statPersonnelOK').textContent=stats.ok;
            document.getElementById('statPersonnelKO').textContent=stats.ko;
            document.getElementById('statPersonnelRefuse').textContent=stats.refuse;
            loadGlobalStats()
        }
        
        async function loadGlobalStats(){
            if(!apiUrl||!currentListName)return;
            try{
                const response=await fetch(`${apiUrl}?action=getStats&listeName=${encodeURIComponent(currentListName)}&t=${Date.now()}`);
                const data=await response.json();
                if(data.success){
                    document.getElementById('statGlobalOK').textContent=data.totalOK||0;
                    document.getElementById('statGlobalKO').textContent=data.totalKO||0;
                    const totalRefuse=localCache.length-(data.totalOK+data.totalKO);
                    document.getElementById('statGlobalRefuse').textContent=totalRefuse>0?totalRefuse:0;
                    const singleLocationLists=['AG','TERROIR','GALA','MIDI - MER','MIDI - JEU'];
                    if(singleLocationLists.includes(currentListName)){
                        const restantTotal=localCache.length-(data.totalOK||0);
                        const el=document.getElementById('statRestantTotal');
                        if(el)el.textContent=restantTotal>0?restantTotal:0
                    }else{
                        document.getElementById('statRestantConf').textContent=data.enAttenteConf||0;
                        document.getElementById('statRestantAtel').textContent=data.enAttenteAtel||0
                    }
                }
            }catch(e){
                console.log('Erreur chargement stats globales:',e)
            }
        }
        
        function startStatsRefresh(){
            if(statsRefreshInterval)clearInterval(statsRefreshInterval);
            statsRefreshInterval=setInterval(()=>{
                loadGlobalStats()
            },10000)
        }
        
        function stopStatsRefresh(){
            if(statsRefreshInterval){
                clearInterval(statsRefreshInterval);
                statsRefreshInterval=null
            }
        }
        
        function esc(txt){
            const div=document.createElement('div');
            div.textContent=txt;
            return div.innerHTML
        }
        
        function beepAtelierA(){
            try{
                const ctx=new(window.AudioContext||window.webkitAudioContext)();
                const osc=ctx.createOscillator();
                const gain=ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value=1000;
                gain.gain.setValueAtTime(0.3,ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.15);
                osc.start();
                osc.stop(ctx.currentTime+0.15)
            }catch(e){}
        }
        
        function beepMauvaisMode(){
            try{
                const ctx=new(window.AudioContext||window.webkitAudioContext)();
                for(let i=0;i<3;i++){
                    const osc=ctx.createOscillator();
                    const gain=ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value=250;
                    const startTime=ctx.currentTime+(i*0.15);
                    gain.gain.setValueAtTime(0.3,startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01,startTime+0.12);
                    osc.start(startTime);
                    osc.stop(startTime+0.12)
                }
            }catch(e){}
        }
        
        function beepNonAutorise(){
            try{
                const ctx=new(window.AudioContext||window.webkitAudioContext)();
                for(let i=0;i<5;i++){
                    const osc=ctx.createOscillator();
                    const gain=ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value=250;
                    const startTime=ctx.currentTime+(i*0.15);
                    gain.gain.setValueAtTime(0.3,startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01,startTime+0.12);
                    osc.start(startTime);
                    osc.stop(startTime+0.12)
                }
            }catch(e){}
        }
        
        function toggleFullscreen(){
            if(!isFullscreen){
                requestFullscreen()
            }else{
                exitFullscreen()
            }
        }
        
        function requestFullscreen(){
            const elem=document.documentElement;
            if(elem.requestFullscreen){
                elem.requestFullscreen().then(()=>{
                    isFullscreen=true;
                    updateFullscreenButton()
                }).catch(err=>console.log('Erreur fullscreen:',err))
            }else if(elem.webkitRequestFullscreen){
                elem.webkitRequestFullscreen();
                isFullscreen=true;
                updateFullscreenButton()
            }else if(elem.mozRequestFullScreen){
                elem.mozRequestFullScreen();
                isFullscreen=true;
                updateFullscreenButton()
            }else if(elem.msRequestFullscreen){
                elem.msRequestFullscreen();
                isFullscreen=true;
                updateFullscreenButton()
            }
        }
        
        function exitFullscreen(){
            if(document.exitFullscreen){
                document.exitFullscreen().then(()=>{
                    isFullscreen=false;
                    updateFullscreenButton()
                }).catch(err=>console.log('Erreur sortie fullscreen:',err))
            }else if(document.webkitExitFullscreen){
                document.webkitExitFullscreen();
                isFullscreen=false;
                updateFullscreenButton()
            }else if(document.mozCancelFullScreen){
                document.mozCancelFullScreen();
                isFullscreen=false;
                updateFullscreenButton()
            }else if(document.msExitFullscreen){
                document.msExitFullscreen();
                isFullscreen=false;
                updateFullscreenButton()
            }
        }
        
        function updateFullscreenButton(){
            const btn=document.getElementById('fullscreenBtn');
            btn.textContent=isFullscreen?'‚õ∂':'‚õ∂';
            btn.title=isFullscreen?'Quitter le plein √©cran':'Plein √©cran'
        }
        
        document.addEventListener('fullscreenchange',()=>{
            isFullscreen=!!document.fullscreenElement;
            updateFullscreenButton()
        });
        document.addEventListener('webkitfullscreenchange',()=>{
            isFullscreen=!!document.webkitFullscreenElement;
            updateFullscreenButton()
        });
        document.addEventListener('mozfullscreenchange',()=>{
            isFullscreen=!!document.mozFullScreenElement;
            updateFullscreenButton()
        });
        document.addEventListener('msfullscreenchange',()=>{
            isFullscreen=!!document.msFullscreenElement;
            updateFullscreenButton()
        });
